<h1 class="page-title">Class Members</h1>


<div class="row">
    <div class="col-lg-2">
        <app-card title="Classes" subtitle="Term Classes">
            <app-term-class (termClassSelected)="selectTermClass($event)" ></app-term-class>
        </app-card>

    </div>


    <div class="col-lg-10">

        <app-card title="Members - {{selectedTermClass?.schoolClassName}}" subtitle="List of students in the selected class">
            <div class="card-body">
                <!-- Loading State -->
                <div class="loading" *ngIf="isLoading">
                    <p-progressSpinner styleClass="w-2rem h-2rem"></p-progressSpinner>
                    <span class="ml-2">Loading...</span>
                </div>

                <!-- Error State -->
                <div *ngIf="!isLoading && error" class="error">
                    <i class="pi pi-exclamation-triangle mr-2"></i>
                    {{ error }}
                </div>

                <!-- Tabbed Data View -->

       <div id="dataView" *ngIf="!isLoading && !error">
           <p-tabView>
               <p-tabPanel header="Picture View">
                   <!-- Search box for filtering picture view -->
                   <div class="p-input-icon-left mb-3" style="width: 100%; max-width: 320px;">
                       <i class="pi pi-search"></i>
                       <input pInputText type="text" [(ngModel)]="pictureSearchText" placeholder="Search members..." class="w-100"/>
                   </div>

                   <div class="row">

                       <div class="col-2" *ngFor="let item of pictureViewFiltered">
                           <div class="card text-center p-3">
                               <div class="mb-2" style="cursor: pointer;" (click)="takePicture(item)" pTooltip="Click to take picture">
                                   <img [src]="getStudentImageSrc(item)"
                                        alt="student photo"
                                         style="width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; background: #f3f4f6;"/>
                               </div>
                               <div class="font-medium" style="font-weight: bold">{{ item.personName }}</div>
                               <div class="text-500" style="font-size: 0.9rem;">{{ item.referenceNo}}</div>
                           </div>
                       </div>

                   </div>
                   <div class="grid">

                   </div>
               </p-tabPanel>
               <p-tabPanel header="List View">
                   <!-- Existing table as list view -->
                   <p-table #dt [value]="studentList" [paginator]="true" [rows]="10" styleClass="p-datatable-sm" [globalFilterFields]="['referenceNo','personName','studentId','studentName']">
                       <ng-template pTemplate="caption">
                           <div class="p-input-icon-left" style="width: 100%; max-width: 320px;">
                               <i class="pi pi-search"></i>
                               <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')" placeholder="Search members..." class="w-100"/>
                           </div>
                       </ng-template>
                       <ng-template pTemplate="header">
                           <tr>
                               <th ></th>
                               <th pSortableColumn="studentId">Student No <p-sortIcon field="studentId"></p-sortIcon></th>
                               <th pSortableColumn="studentName">Full Name <p-sortIcon field="studentName"></p-sortIcon></th>
                               <th class="text-center" style="width: 200px;"></th>
                               <th class="text-center" style="width: 200px;"></th>
                           </tr>
                       </ng-template>
                       <ng-template pTemplate="body" let-item>
                           <tr>
                               <td>
                                   <img [src]="getStudentImageSrc(item)"
                                        alt="student photo"
                                        style="width: 60px; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; background: #f3f4f6;"/>
                               </td>
                               <td>{{ item.personName }}</td>
                               <td>{{ item.referenceNo}}</td>
                               <td class="text-center">
                                   <div class="d-flex justify-content-center" style="gap: 8px;">
                                       <p-button icon="pi pi-camera" label="Take Picture" [rounded]="true" size="small"
                                                 [disabled]="isLoading" pTooltip="Take Picture"
                                                 (onClick)="takePicture(item)"></p-button>
                                   </div>

                               </td>
                               <td class="text-center">
                                   <div class="d-flex justify-content-center mt-2" style="gap: 8px;">
                                       <p-button icon="pi pi-send" label="Send Data" [rounded]="true" size="small"
                                                 [disabled]="isLoading" pTooltip="Send Data"
                                                 (onClick)="sendDataToDevice(item)"></p-button>
                                   </div>
                               </td>
                           </tr>
                       </ng-template>
                       <ng-template pTemplate="emptymessage">
                           <tr>
                               <td colspan="3" class="text-center">No members found</td>
                           </tr>
                       </ng-template>
                   </p-table>
               </p-tabPanel>
           </p-tabView>
       </div>

            </div>
        </app-card>

    </div>
</div>


<!-- Attendance Registration Dialog moved into reusable component -->
<app-device-capture [(visible)]="showDialog" [student]="activeStudent" (saved)="onCaptureSaved($event)"></app-device-capture>

