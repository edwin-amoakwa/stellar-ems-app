<h1 class="page-title">SMS Records</h1>

<app-card title="SMS Records">
  <div class="card-body">
    <!-- Filter Section -->
    <div class="row mb-3 g-3">
      <div class="col-md-3">
        <label for="phoneNo" class="form-label">Phone No</label>
        <input pInputText id="phoneNo" [(ngModel)]="filterParam.phoneNo" placeholder="Enter phone number" class="w-100" />
      </div>
      <div class="col-md-3">
        <label for="referenceNo" class="form-label">Reference No</label>
        <input pInputText id="referenceNo" [(ngModel)]="filterParam.referenceNo" placeholder="Enter reference no" class="w-100" />
      </div>
      <div class="col-md-3">
        <label for="relatedPersonName" class="form-label">Related Person</label>
        <input pInputText id="relatedPersonName" [(ngModel)]="filterParam.relatedPersonName" placeholder="Enter name" class="w-100" />
      </div>
      <div class="col-md-3">
        <label for="sentStatus" class="form-label">Sent Status</label>
        <p-dropdown id="sentStatus"
                    [options]="sentStatusOptions"
                    [(ngModel)]="filterParam.sentStatus"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="All"
                    [showClear]="true"
                    styleClass="w-100">
        </p-dropdown>
      </div>
      <div class="col-md-3">
        <label for="emailSent" class="form-label">Email Sent</label>
        <p-dropdown id="emailSent"
                    [options]="yesNoOptions"
                    [(ngModel)]="filterParam.emailSent"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="All"
                    [showClear]="true"
                    styleClass="w-100">
        </p-dropdown>
      </div>
      <div class="col-md-3">
        <label for="smsSent" class="form-label">SMS Sent</label>
        <p-dropdown id="smsSent"
                    [options]="yesNoOptions"
                    [(ngModel)]="filterParam.smsSent"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="All"
                    [showClear]="true"
                    styleClass="w-100">
        </p-dropdown>
      </div>
      <div class="col-md-3">
        <label for="whatsAppSent" class="form-label">WhatsApp Sent</label>
        <p-dropdown id="whatsAppSent"
                    [options]="yesNoOptions"
                    [(ngModel)]="filterParam.whatsAppSent"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="All"
                    [showClear]="true"
                    styleClass="w-100">
        </p-dropdown>
      </div>
      <div class="col-md-3 d-flex align-items-end gap-2">
        <p-button label="Search" icon="pi pi-search" severity="primary" size="small" (onClick)="loadSmsRecords()"></p-button>
        <p-button label="Clear Filters" icon="pi pi-filter-slash" severity="secondary" size="small" (onClick)="clearFilters()"></p-button>
      </div>
    </div>

    <!-- SMS Records Table -->
    <p-table
      [value]="smsRecords"
      [loading]="isLoading"
      [paginator]="true"
      [rows]="20"
      styleClass="p-datatable-sm"
      [scrollable]="true"
      scrollHeight="600px"
      dataKey="referenceNo">

      <ng-template pTemplate="header">
        <tr>
          <th style="width:40px"></th>
          <th>Phone No</th>
          <th>Message</th>
          <th>Reference No</th>
          <th>Related Person</th>
          <th>Person Type</th>
          <th>Sent Status</th>
          <th>Email Sent</th>
          <th>SMS Sent</th>
          <th>WhatsApp Sent</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-record let-expanded="expanded">
        <tr>
          <td>
            <p-button type="button" [pRowToggler]="record" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" severity="secondary" size="small" [text]="true"></p-button>
          </td>
          <td>{{ record.phoneNo }}</td>
          <td>
            <div class="text-truncate" style="max-width: 260px;" [pTooltip]="record.message">
              {{ truncateText(record.message, 60) }}
            </div>
          </td>
          <td>{{ record.referenceNo }}</td>
          <td>{{ record.relatedPersonName }}</td>
          <td>{{ record.relatedPersonType }}</td>
          <td>
            <p-tag [value]="record.sentStatus" [severity]="getSmsStatusSeverity(record.sentStatus)"></p-tag>
          </td>
          <td>
            <p-tag [value]="record.emailSent ? 'YES' : 'NO'" [severity]="getYesNoSeverity(record.emailSent)"></p-tag>
          </td>
          <td>
            <p-tag [value]="record.smsSent ? 'YES' : 'NO'" [severity]="getYesNoSeverity(record.smsSent)"></p-tag>
          </td>
          <td>
            <p-tag [value]="record.whatsAppSent ? 'YES' : 'NO'" [severity]="getYesNoSeverity(record.whatsAppSent)"></p-tag>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="rowexpansion" let-record>
        <tr>
          <td colspan="10">
            <div class="p-3">
              <h5>Additional Details</h5>
              <div class="row">
                <div class="col-md-4">
                  <div class="mb-2">
                    <strong>Group Message:</strong>
                    <p-tag class="ms-2" [value]="record.groupMessage ? 'YES' : 'NO'" [severity]="getYesNoSeverity(record.groupMessage)"></p-tag>
                  </div>
                  <div class="mb-2">
                    <strong>Pages Count:</strong>
                    <span class="ms-2">{{ record.pagesCount }}</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-2">
                    <strong>Unit Price:</strong>
                    <span class="ms-2">{{ formatCurrency(record.unitPrice) }}</span>
                  </div>
                  <div class="mb-2">
                    <strong>SMS Cost:</strong>
                    <span class="ms-2">{{ formatCurrency(record.smsCost) }}</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-2">
                    <strong>Created Date/Time:</strong>
                    <span class="ms-2">{{ formatDateTime(record.createdDateTime || record.createdDate) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="10" class="text-center p-4">
            <div class="flex flex-column align-items-center gap-2">
              <i class="pi pi-inbox text-4xl text-muted"></i>
              <p class="text-muted mb-0">No SMS records found</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</app-card>
