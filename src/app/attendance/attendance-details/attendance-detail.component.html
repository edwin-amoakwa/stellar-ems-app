<div id="detailView">
  <div id="selectedAttendanceInfo" *ngIf="attendance as sa">
    <div class="mb-3">
      <div class="h5 mb-1">{{ sa.attendanceName }}</div>
      <div class="text-muted">
        {{ sa.valueDate | date:'fullDate' }} â€¢ {{ sa.attendeesLabel }}
      </div>
    </div>
    <div class="d-flex flex-wrap gap-3 mb-3">
      <span><strong>Attendees:</strong> {{ sa.attendeesCount }}</span>
      <span><strong>Present:</strong> {{ sa.presentAttendees }}</span>
      <span><strong>Summary:</strong> {{ sa.attendanceSummary }}</span>
    </div>
  </div>

  <button-toolbar>
    <button pButton type="button" label="All"
            class="p-button-sm"
            [class.p-button-outlined]="currentFilter !== AttendanceFilter.ALL"
            (click)="setFilter(AttendanceFilter.ALL)"></button>
    <button pButton type="button" label="Present"
            class="p-button-sm"
            [class.p-button-outlined]="currentFilter !== AttendanceFilter.PRESENT"
            (click)="setFilter(AttendanceFilter.PRESENT)"></button>

    <button pButton type="button" label="Absent"
            class="p-button-sm"
            [class.p-button-outlined]="currentFilter !== AttendanceFilter.ABSENT"
            (click)="setFilter(AttendanceFilter.ABSENT)"></button>

    <span class="p-input-icon-left">
      <i class="pi pi-search"></i>
      <input pInputText type="text" placeholder="Search attendees" (input)="attendeesTable.filterGlobal($any($event.target).value, 'contains')" />
    </span>

    <close-button (click)="close.emit()"></close-button>

  </button-toolbar>

  <div class="mb-3 d-flex align-items-center"></div>

  <p-table #attendeesTable [value]="filteredAttendees" [paginator]="true" [rows]="10" styleClass="p-datatable-sm" [globalFilterFields]="['attendeeRefNo','attendeeName','present','clockInTime','clockOutTime']">
    <ng-template pTemplate="header">
      <tr>
        <th>Student No</th>
        <th>Name</th>
        <th>Present</th>
        <th>Clock In</th>
        <th>Clock Out</th>
        <th style="width: 16rem;">Actions</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-item>
      <tr>
        <td>{{ item.attendeeRefNo }}</td>
        <td>{{ item.attendeeName }}</td>
        <td>
          <ng-container *ngIf="editingId !== (item.id ?? item.attendeeId); else editPresentTpl">
            <span [ngClass]="item.present ? 'text-success' : 'text-danger'">{{ item.present ? 'Yes' : 'No' }}</span>
          </ng-container>
          <ng-template #editPresentTpl>
            <input type="checkbox" [(ngModel)]="editModel.present" />
          </ng-template>
        </td>
        <td>
          <ng-container *ngIf="editingId !== (item.id ?? item.attendeeId); else editInTpl">
            {{ item.inTime }}
          </ng-container>
          <ng-template #editInTpl>
            <input type="time" [(ngModel)]="editModel.clockInTime" />
          </ng-template>
        </td>
        <td>
          <ng-container *ngIf="editingId !== (item.id ?? item.attendeeId); else editOutTpl">
            {{ item.outTime  }}
          </ng-container>
          <ng-template #editOutTpl>
            <input type="time" [(ngModel)]="editModel.clockOutTime" />
          </ng-template>
        </td>
        <td class="d-flex gap-2">
          <ng-container *ngIf="editingId === (item.id ?? item.attendeeId); else viewActions">
            <button pButton type="button" label="Save" icon="pi pi-check" class="p-button-sm p-button-success"
                    [disabled]="savingId === (item.id ?? item.attendeeId)"
                    (click)="saveEdit(item)"></button>
            <button pButton type="button" label="Cancel" icon="pi pi-times" class="p-button-sm p-button-secondary"
                    (click)="cancelEdit()"></button>
          </ng-container>
          <ng-template #viewActions>
            <button pButton type="button" label="Edit" icon="pi pi-pencil" class="p-button-sm"
                    (click)="startEdit(item)"></button>
            <button pButton type="button" icon="pi pi-bell" class="p-button-sm p-button-warning"
                    [disabled]="notifyingId === (item.id ?? item.attendeeId)"
                    (click)="notify(item)"></button>
          </ng-template>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center">No members found</td>
      </tr>
    </ng-template>
  </p-table>
</div>
